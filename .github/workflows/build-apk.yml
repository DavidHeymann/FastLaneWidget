name: Build Android APK

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    env:
      KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
      KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
      KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    # Cache wrapper files (reuse existing gradle-wrapper-8.0 cache)
    - name: Cache Gradle wrapper files
      id: cache-wrapper
      uses: actions/cache@v3
      with:
        path: |
          gradle/wrapper/gradle-wrapper.jar
          gradlew
          gradlew.bat
        key: gradle-wrapper-8.0

    # Create hash of dependencies and build config (excluding version changes)
    - name: Create dependencies hash
      id: deps-hash
      run: |
        # Extract dependencies block from build.gradle
        if grep -q "^dependencies {" app/build.gradle; then
          sed -n '/^dependencies {/,/^}/p' app/build.gradle > /tmp/deps.txt
        else
          cat app/build.gradle > /tmp/deps.txt
        fi
        # Extract compileSdk, minSdk, targetSdk (but not versionCode/versionName)
        grep -E "compileSdk|minSdk|targetSdk" app/build.gradle >> /tmp/deps.txt
        # Include gradle wrapper properties (Gradle version)
        cat gradle/wrapper/gradle-wrapper.properties >> /tmp/deps.txt
        # Create hash
        HASH=$(md5sum /tmp/deps.txt | cut -d' ' -f1)
        echo "hash=$HASH" >> $GITHUB_OUTPUT

    # Cache Gradle dependencies (hash changes only when dependencies change)
    - name: Cache Gradle dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: gradle-deps-${{ runner.os }}-${{ steps.deps-hash.outputs.hash }}
        restore-keys: |
          gradle-deps-${{ runner.os }}-

    # Only download and generate wrapper if NOT cached
    - name: Install Gradle
      if: steps.cache-wrapper.outputs.cache-hit != 'true'
      run: |
        echo "Wrapper not cached, downloading Gradle 8.0..."
        # Retry up to 3 times with timeout
        for i in 1 2 3; do
          if wget --timeout=30 --tries=3 https://services.gradle.org/distributions/gradle-8.0-bin.zip; then
            break
          fi
          echo "Download attempt $i failed, retrying..."
          sleep 5
        done
        unzip -q gradle-8.0-bin.zip
        export GRADLE_HOME=$PWD/gradle-8.0
        export PATH=$GRADLE_HOME/bin:$PATH
        gradle --version

    - name: Generate Gradle Wrapper
      if: steps.cache-wrapper.outputs.cache-hit != 'true'
      run: |
        echo "Generating wrapper files..."
        export GRADLE_HOME=$PWD/gradle-8.0
        export PATH=$GRADLE_HOME/bin:$PATH
        gradle wrapper --gradle-version 8.0
        ls -la gradle/wrapper/

    - name: Make gradlew executable
      run: chmod +x ./gradlew
    
    # Decode keystore from base64 secret (if exists)
    - name: Decode Keystore
      if: env.KEYSTORE_BASE64 != ''
      run: |
        echo "$KEYSTORE_BASE64" | base64 -d > app/release-keystore.jks
        echo "Keystore decoded successfully"
    
    # Build Release APK if keystore exists
    - name: Build Release APK
      if: env.KEYSTORE_BASE64 != ''
      run: ./gradlew assembleRelease --stacktrace --no-daemon
    
    # Build Debug APK
    - name: Build Debug APK
      run: ./gradlew assembleDebug --stacktrace --no-daemon
    
    # Upload Release APK if it exists
    - name: Upload Release APK
      if: env.KEYSTORE_BASE64 != ''
      uses: actions/upload-artifact@v4
      with:
        name: FastLaneWidget-Release
        path: app/build/outputs/apk/release/app-release.apk
        retention-days: 30
    
    # Upload Debug APK
    - name: Upload Debug APK
      uses: actions/upload-artifact@v4
      with:
        name: FastLaneWidget-Debug
        path: app/build/outputs/apk/debug/app-debug.apk
        retention-days: 30
